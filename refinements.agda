module refinements
  (ğ’® : Set)
  where

  open import Agda.Primitive

  record Unit {â„“} : Set â„“ where
    constructor tt

  record âˆ {â„“â° â„“Â¹} (A : Set â„“â°) (B : A â†’ Set â„“Â¹) : Set (â„“â° âŠ” â„“Â¹) where
    constructor _,_
    field
      fst : A
      snd : B fst


  data SCtx : Set where
    [] : SCtx
    _,_ : SCtx â†’ ğ’® â†’ SCtx

  module _
    (tm : SCtx â†’ ğ’® â†’ Set)
    (_â†ª_ : SCtx â†’ SCtx â†’ Set)
    (_âˆ˜_ : {Î¥ Î¥â€² Î¥â€³ : SCtx} â†’ Î¥â€² â†ª Î¥â€³ â†’ Î¥ â†ª Î¥â€² â†’ Î¥ â†ª Î¥â€³)
    (_[_] : {Î¥ Î¥â€² : SCtx} {Ï„ : ğ’®} â†’ tm Î¥ Ï„ â†’ Î¥ â†ª Î¥â€² â†’ tm Î¥â€² Ï„)
    where

    mutual
      data refâ‹† : SCtx â†’ Setâ‚ where
        [] : refâ‹† []
        _,_ : {Î¥ : SCtx} {Ï„ : ğ’®} (Î¨ : refâ‹† Î¥) (Ï† : ref Î¨ Ï„) â†’ refâ‹† (Î¥ , Ï„)


      postulate
        _â†ª[_]_ : {Î¥ Î¥â€² : SCtx} (Î¨ : refâ‹† Î¥) (Ï± : Î¥ â†ª Î¥â€²) (Î¨â€² : refâ‹† Î¥â€²) â†’ Setâ‚
        _[âˆ˜]_ : {Î¥ Î¥â€² Î¥â€³ : SCtx} {Ï± : _} {Ï±â€² : _} {Î¨ : refâ‹† Î¥} {Î¨â€² : refâ‹† Î¥â€²} {Î¨â€³ : refâ‹† Î¥â€³} â†’ Î¨â€² â†ª[ Ï±â€² ] Î¨â€³ â†’ Î¨ â†ª[ Ï± ] Î¨â€² â†’ Î¨ â†ª[ Ï±â€² âˆ˜ Ï± ] Î¨â€³

      record ref {Î¥ : SCtx} (Î¨ : refâ‹† Î¥) (Ï„ : ğ’®) : Setâ‚ where
        field
          pred :
            {Î¥â€² : SCtx}
            (Ï± : Î¥ â†ª Î¥â€²)
            (M N : tm Î¥â€² Ï„)
              â†’ Set
          pred-symm :
            {Î¥â€² : SCtx}
            {Ï± : Î¥ â†ª Î¥â€²}
            (M N : tm Î¥â€² Ï„)
              â†’ pred Ï± M N
              â†’ pred Ï± N M
          pred-trans :
            {Î¥â€² : SCtx}
            {Ï± : Î¥ â†ª Î¥â€²}
            (M N O : tm Î¥â€² Ï„)
            â†’ pred Ï± N O
            â†’ pred Ï± M N
            â†’ pred Ï± M O
            {-
          pred-resp :
            {Î¥â€² Î¥â€³ : SCtx}
            (Î¨â€² : refâ‹† Î¥â€²)
            (Î¨â€³ : refâ‹† Î¥â€³)
            {Ï± : Î¥ â†ª Î¥â€²}
            {Ï±â€² : Î¥â€² â†ª Î¥â€³}
            ([Ï±] : Î¨ â†ª[ Ï± ] Î¨â€²)
            ([Ï±â€²] : Î¨â€² â†ª[ Ï±â€² ] Î¨â€³)
            (M N : tm Î¥â€² Ï„)
              â†’ pred [Ï±] M N
              â†’ pred ([Ï±â€²] [âˆ˜] [Ï±]) (M [ Ï±â€² ]) (N [ Ï±â€² ])
-}

      _âˆ¥_âŠ†_ : {Î¥ : SCtx} (Î¨ : refâ‹† Î¥) {Ï„ : ğ’®} (Ï† Ïˆ : ref Î¨ Ï„) â†’ Setâ‚
      _âˆ¥_âŠ†_ {Î¥ = Î¥} Î¨ {Ï„ = Ï„} Ï† Ïˆ =
        {Î¥â€² Î¥â€³ : SCtx}
        (Î¨â€² : refâ‹† Î¥â€²)
        (Î¨â€³ : refâ‹† Î¥â€³)
        {Ï± : Î¥ â†ª Î¥â€²}
        {Ï±â€² : Î¥â€² â†ª Î¥â€³}
        ([Ï±] : Î¨ â†ª[ Ï± ] Î¨â€²)
        ([Ï±â€²] : Î¨â€² â†ª[ Ï±â€² ] Î¨â€³)
        (M N : tm Î¥â€² Ï„)
          â†’ ref.pred Ï† Ï± M N
          â†’ ref.pred Ïˆ (Ï±â€² âˆ˜ Ï±) (M [ Ï±â€² ]) (N [ Ï±â€² ])

      data _âŠ†â‹†_ : {Î¥ : SCtx} (Î¨ Î¨â€² : refâ‹† Î¥) â†’ Setâ‚ where
        [] : [] âŠ†â‹† []
        _,_ : {Î¥ : SCtx} {Ï„ : ğ’®} {Î¨ Î¨â€² : refâ‹† Î¥} (p : Î¨ âŠ†â‹† Î¨â€²) (Ï† : ref Î¨ Ï„) (Ïˆ : ref Î¨â€² Ï„) â†’ Î¨â€² âˆ¥ Ï† âŠ†â‹†[ p ] âŠ† Ïˆ â†’ (Î¨ , Ï†) âŠ†â‹† (Î¨â€² , Ïˆ)

      _âŠ†â‹†[_] : {Î¥ : SCtx} {Ï„ : ğ’®} {Î¨ Î¨â€² : refâ‹† Î¥} â†’ ref Î¨ Ï„ â†’ Î¨ âŠ†â‹† Î¨â€² â†’ ref Î¨â€² Ï„
      Ï† âŠ†â‹†[ _ ] =
        record
          { pred = ref.pred Ï†
          ; pred-symm = ref.pred-symm Ï†
          ; pred-trans = ref.pred-trans Ï†
          }
